name: Deploy to GCP

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to GCP Compute Engine
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Trigger instance update
        run: |
          gcloud compute instances add-metadata randomvalidator-instance \
            --zone=${{ secrets.GCP_ZONE }} \
            --metadata=deployment-trigger="$(date +%s)"

      - name: SSH and deploy
        run: |
          gcloud compute ssh randomvalidator-instance \
            --zone=${{ secrets.GCP_ZONE }} \
            --command="
              set -e
              cd /opt/randomvalidator
              git pull origin main
              cd nist/sts-2.1.2/sts-2.1.2
              make clean && make
              cd /opt/randomvalidator
              source \$HOME/.cargo/env
              cargo build --release --bin server
              sudo systemctl restart randomvalidator
              echo 'Deployment complete!'
            "

      - name: Verify deployment
        run: |
          INSTANCE_IP=$(gcloud compute instances describe randomvalidator-instance \
            --zone=${{ secrets.GCP_ZONE }} \
            --format='get(networkInterfaces[0].accessConfigs[0].natIP)')
          echo "Application URL: http://$INSTANCE_IP:3000"
          sleep 10
          curl -f "http://$INSTANCE_IP:3000" || echo "Warning: Application may still be starting"
